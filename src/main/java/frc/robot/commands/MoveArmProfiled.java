// Copyright (c) FIRST and other WPILib contributors.
// Open Source Software; you can modify and/or share it under the terms of
// the WPILib BSD license file in the root directory of this project.

package frc.robot.commands;

import java.util.HashMap;

import edu.wpi.first.wpilibj.Timer;
import edu.wpi.first.wpilibj.smartdashboard.SmartDashboard;
// import edu.wpi.first.wpilibj.smartdashboard.SmartDashboard;
import edu.wpi.first.wpilibj2.command.CommandBase;
import frc.robot.Constants.Arm.Tolerances;
import frc.robot.subsystems.ArmGripper;
// import frc.robot.utils.BeaverLogger;

public class MoveArmProfiled extends CommandBase {
  double[][] currentPath;
  double UpperError, UpperArm_P;
  double LowerError, LowerArm_P;
  ArmGripper m_armGripper;
  HashMap<String,double[][]> paths = new HashMap<String,double[][]>();
  int i = 0;
  double startTime;
  double jointErrorTolerance = Math.sqrt(50+Math.pow(3*Tolerances.EXTENSION_LENGTH,2)); // 5 Degrees each way
  boolean isReverse = false;
  String currProfile;

  public void createMap(){
    paths.put("LongThrowMid", new double[][]{{104.6,21.09000000000001,0.0},
      {104.55465357828778,22.123830386726777,0.0},
      {104.42968490717931,25.016554159876087,0.0},
      {104.24655879877662,29.45016131784148,0.0},
      {104.0269242740065,35.1064576501918,0.0},
      {103.78978299250845,41.66989630778309,0.0},
      {103.55113998390166,48.82792707149196,0.0},
      {103.32522138670555,56.2697786132945,0.0},
      {103.127014988728,63.683917955878435,0.0},
      {102.9769462107873,70.75337448892111,0.0},
      {102.61134083371442,77.1452772420874,0.0},
      {101.81240351436242,82.4808763690195,0.0},
      {101.5147767947738,86.22898413817083,0.0},
      {101.16870314197386,87.34281289301157,0.0},
      {100.64298677151268,90.85701322848735,0.0},
      {99.5,93.99999999999999,0.0},
      {96.16269579954607,97.48016134331105,0.0},
      {92.1119805843657,101.93087655849142,0.0},
      {88.35620596272244,106.30093689442043,0.0},
      {84.67620776469111,110.76664937816604,0.0},
      {81.24662571216858,115.11051714497427,0.0},
      {78.03995458995445,119.31718826718841,0.0},
      {75.07650515594196,123.32349484405803,0.0},
      {72.37039801244245,127.07245913041471,0.0},
      {69.94613909373992,130.49671804911722,0.0},
      {67.83772299823622,133.51941985890667,0.0},
      {66.08942786865668,136.05342927420045,0.0},
      {64.75573571530187,138.00140714184099,0.0},
      {63.90103108877357,139.2561117683693,0.0},
      {63.599444373251984,139.700555626748,0.0}});
    
    paths.put("ShortThrowMid", new double[][]{
      {101.0,101.0,0.0},
      {100.81264467592592,101.25824652777779,0.0},
      {100.27199074074075,102.00347222222223,0.0},
      {99.41015625,103.19140625,0.0},
      {98.25925925925925,104.77777777777777,0.0},
      {96.85141782407408,106.71831597222223,0.0},
      {95.21875,108.96875000000001,0.0},
      {93.3933738425926,111.48480902777777,0.0},
      {91.4074074074074,114.22222222222223,0.0},
      {89.29296875000001,117.13671875,0.0},
      {87.08217592592592,120.18402777777777,0.0},
      {84.80714699074075,123.31987847222221,0.0},
      {82.50000000000001,126.5,0.0},
      {80.19285300925927,129.68012152777777,0.0},
      {77.91782407407409,132.8159722222222,0.0},
      {75.70703125000001,135.86328125,0.0},
      {73.59259259259258,138.77777777777777,0.0},
      {71.6066261574074,141.5151909722222,0.0},
      {69.78125,144.03125,0.0},
      {68.14858217592594,146.28168402777777,0.0},
      {66.74074074074073,148.22222222222223,0.0},
      {65.58984375,149.80859375,0.0},
      {64.72800925925927,150.99652777777777,0.0},
      {64.18735532407408,151.74175347222223,0.0},
      {64.0,152.0,0.0},
  });
    paths.put("PickToStow", new double[][]{{98.9,91.3,0.0},
    {99.0954732510288,88.89224965706447,0.0},
    {99.61934156378601,82.43947873799725,0.0},
    {100.37777777777777,73.09740740740742,0.0},
    {101.27695473251029,62.02175582990397,0.0},
    {102.22304526748972,50.36824417009601,0.0},
    {103.12222222222222,39.2925925925926,0.0},
    {103.88065843621399,29.950521262002766,0.0},
    {104.4045267489712,23.49775034293552,0.0}});
    paths.put("LongThrowPickup", new double[][]{
      {104.6,21.09000000000001,0.0},
{104.58885995370369,21.491598668981506,8.101851851851852e-05},
{104.55671296296296,22.650497685185186,0.0003148148148148148},
{104.50546874999999,24.49785156250003,0.0006875},
{104.43703703703703,26.964814814814808,0.001185185185185185},
{104.3533275462963,29.98254195601852,0.0017939814814814815},
{104.25625,33.482187500000016,0.0024999999999999996},
{104.14771412037037,37.39490596064814,0.003289351851851851},
{104.02962962962961,41.65185185185187,0.004148148148148148},
{103.90390624999999,46.18417968750001,0.0050625},
{103.77245370370369,50.9230439814815,0.006018518518518518},
{103.63718171296297,55.799599247685165,0.007002314814814814},
{103.5,60.74500000000001,0.008},
{103.36281828703704,65.69040075231483,0.008997685185185185},
{103.22754629629628,70.5669560185185,0.009981481481481478},
{103.09609375,75.3058203125,0.0109375},
{102.97037037037038,79.83814814814815,0.011851851851851853},
{102.85228587962963,84.09509403935186,0.012710648148148146},
{102.74375,88.00781250000001,0.013499999999999998},
{102.6466724537037,91.50745804398147,0.014206018518518514},
{102.56296296296297,94.5251851851852,0.014814814814814815},
{102.49453125,96.9921484375,0.0153125},
{102.44328703703704,98.83950231481481,0.01568518518518518},
{102.4111400462963,99.99840133101853,0.015918981481481482},
{102.4,100.4,0.016},
  });
    paths.put("PickupToHigh", new double[][]{
      {102.4,100.4,0.016},
      {102.34453841511615,100.47875545053508,0.01649792178429056},
      {102.18121360997544,100.71067667383488,0.01796421559044276},
      {101.91461550884412,101.08924597744138,0.020357674098377375},
      {101.54933403598841,101.60794566889646,0.02363708998801519},
      {101.08995911567459,102.26025805574209,0.027761255939277},
      {100.5410806721689,103.03966544552016,0.03268896463208357},
      {99.90728862973761,103.93965014577259,0.03837900874635568},
      {99.19317291264694,104.95369446404135,0.04479018096201412},
      {98.40332344516317,106.07528070786833,0.05188127395897967},
      {97.5423301515525,107.29789118479545,0.059611080417173105},
      {96.61478295608123,108.61500820236466,0.06793839301651522},
      {95.62527178301559,110.02011406811786,0.07682200443692679},
      {94.57838655662182,111.50669108959701,0.08622070735832857},
      {93.47871720116618,113.06822157434404,0.0960932944606414},
      {92.33085364091494,114.69818782990083,0.10639855842378598},
      {91.1393858001343,116.3900721638093,0.11709529192768316},
      {89.90890360309056,118.13735688361143,0.12814228765225372},
      {88.64399697404993,119.93352429684911,0.13949833827741837},
      {87.34925583727868,121.7720567110643,0.15112223648309803},
      {86.02927011704308,123.64643643379885,0.16297277494921328},
      {84.68862973760933,125.55014577259476,0.1750087463556851},
      {83.33192462324372,127.47666703499392,0.18718894338243414},
      {81.96374469821248,129.41948252853828,0.19947215870938126},
      {80.58867988678186,131.37207456076976,0.21181718501644722},
      {79.21132011321814,133.32792543923026,0.22418281498355278},
      {77.83625530178753,135.28051747146174,0.23652784129061863},
      {76.46807537675629,137.22333296500608,0.24881105661756572},
      {75.11137026239068,139.14985422740526,0.2609912536443149},
      {73.77072988295694,141.05356356620118,0.27302722505078664},
      {72.4507441627213,142.92794328893572,0.2848777635169019},
      {71.1560030259501,144.76647570315092,0.2965016617225815},
      {69.89109639690948,146.56264311638856,0.3078577123477461},
      {68.66061419986572,148.3099278361907,0.3189047080723168},
      {67.46914635908507,150.00181217009919,0.32960144157621396},
      {66.32128279883382,151.631778425656,0.3399067055393586},
      {65.22161344337819,153.19330891040298,0.3497792926416713},
      {64.17472821698443,154.67988593188215,0.35917799556307317},
      {63.18521704391877,156.08499179763535,0.36806160698348483},
      {62.257669848447506,157.40210881520454,0.3763889195828268},
      {61.39667655483686,158.62471929213166,0.38411872604102026},
      {60.60682708735306,159.74630553595867,0.3912098190379859},
      {59.8927113702624,160.7603498542274,0.3976209912536443},
      {59.258919327831094,161.66033455447985,0.4033110353679164},
      {58.71004088432541,162.43974194425792,0.4082387440607231},
      {58.25066596401162,163.09205433110353,0.41236291001198466},
      {57.88538449115591,163.6107540225586,0.4156423259016226},
      {57.61878639002456,163.98932332616513,0.41803578440955724},
      {57.45546158488384,164.22124454946493,0.41950207821570945},
      {57.40000000000002,164.29999999999998,0.4199999999999999}
        });
    paths.put("LongThrowHigh", new double[][]{
      {104.6,21.09000000000001,0.0},
{104.60708912037036,21.51489149305558,0.0},
{104.6275462962963,22.74100694444446,0.0},
{104.66015624999999,24.695507812500033,0.0},
{104.7037037037037,27.305555555555564,0.0},
{104.75697337962963,30.498311631944436,0.0},
{104.81875,34.200937500000016,0.0},
{104.88781828703704,38.340594618055555,0.0},
{104.96296296296295,42.84444444444445,0.0},
{105.04296875,47.6396484375,0.0},
{105.12662037037036,52.65336805555555,0.0},
{105.2127025462963,57.81276475694444,0.0},
{105.29999999999998,63.044999999999995,0.0},
{105.38729745370371,68.27723524305556,0.0},
{105.47337962962963,73.43663194444443,0.0},
{105.55703125,78.45035156249999,0.0},
{105.63703703703703,83.24555555555555,0.0},
{105.71218171296296,87.74940538194444,0.0},
{105.78124999999999,91.88906250000001,0.0},
{105.84302662037037,95.59168836805554,0.0},
{105.89629629629628,98.78444444444445,0.0},
{105.93984375,101.3944921875,0.0},
{105.97245370370369,103.34899305555555,0.0},
{105.99291087962962,104.57510850694446,0.0},
{106.0,105.0,0.0},
{106.0,105.0,0.0},
{105.84302662037035,105.17722800925925,0.0},
{105.39004629629629,105.6886574074074,0.0},
{104.66796875,106.50390625,0.0},
{103.7037037037037,107.59259259259258,0.0},
{102.52416087962963,108.92433449074072,0.0},
{101.15625,110.46874999999999,0.0},
{99.62688078703704,112.19545717592592,0.0},
{97.96296296296295,114.07407407407406,0.0},
{96.19140625,116.07421875,0.0},
{94.33912037037037,118.16550925925925,0.0},
{92.4330150462963,120.3175636574074,0.0},
{90.5,122.50000000000001,0.0},
{88.56698495370371,124.6824363425926,0.0},
{86.66087962962965,126.83449074074075,0.0},
{84.80859375000001,128.92578125,0.0},
{83.03703703703704,130.92592592592592,0.0},
{81.37311921296298,132.80454282407408,0.0},
{79.84375,134.53124999999997,0.0},
{78.47583912037037,136.07566550925924,0.0},
{77.2962962962963,137.40740740740742,0.0},
{76.33203125,138.49609375000003,0.0},
{75.60995370370371,139.3113425925926,0.0},
{75.15697337962963,139.82277199074073,0.0},
{75.0,140.0,0.0},
{75.0,140.0,0.0},
{74.91087962962963,140.123046875,0.0022280092592592594},
{74.6537037037037,140.478125,0.008657407407407407},
{74.24375,141.044140625,0.01890625},
{73.6962962962963,141.79999999999998,0.03259259259259259},
{73.02662037037038,142.724609375,0.049334490740740734},
{72.25,143.796875,0.06875},
{71.38171296296296,144.995703125,0.0904571759259259},
{70.43703703703703,146.3,0.11407407407407408},
{69.43125,147.68867187499998,0.13921875},
{68.37962962962963,149.140625,0.16550925925925924},
{67.29745370370372,150.634765625,0.19256365740740738},
{66.2,152.15,0.22},
{65.1025462962963,153.665234375,0.24743634259259262},
{64.02037037037037,155.159375,0.2744907407407407},
{62.96875000000001,156.611328125,0.30078125},
{61.962962962962976,158.0,0.32592592592592595},
{61.01828703703704,159.304296875,0.34954282407407405},
{60.15,160.503125,0.37125},
{59.37337962962964,161.575390625,0.39066550925925914},
{58.7037037037037,162.50000000000003,0.4074074074074075},
{58.15625,163.255859375,0.42109375},
{57.74629629629631,163.821875,0.4313425925925925},
{57.48912037037037,164.17695312500004,0.4377719907407408},
{57.400000000000006,164.3,0.44}
    });

    
  }

  public double[] getNearestSetpoint(double dt) {
    double predicted_lower = (m_armGripper.getLowerAngleRelative()+(dt*m_armGripper.getLowerJointAngularVelocity()));
    double predicted_upper = (m_armGripper.getUpperAngleRelative()+(dt*m_armGripper.getUpperJointAngularVelocity()));
    double predicted_extension = (m_armGripper.getExtensionDistance()+(dt*m_armGripper.getExtensionVelocity()));
    double curr_lowerError = Math.abs(predicted_lower-currentPath[i][0]);
    double curr_upperError = Math.abs(predicted_upper-currentPath[i][1]);
    double curr_extensionError = Math.abs(predicted_extension-currentPath[i][2]);
    // Note: i>0 always since we do i++ in initialize.
    double curr_to_prev_jointError = Math.sqrt(Math.pow(curr_lowerError,2)+Math.pow(curr_upperError,2)+Math.pow(curr_extensionError, 2));
    if(i+1<currentPath.length-1){
      double next_lowerError = Math.abs(predicted_lower-currentPath[i+1][0]); 
      double next_upperError = Math.abs(predicted_upper-currentPath[i+1][1]); 
      double next_extensionError = Math.abs(predicted_extension-currentPath[i+1][2]);
      double curr_to_next_jointError = Math.sqrt(Math.pow(next_lowerError,2)+Math.pow(next_upperError,2)+Math.pow(next_extensionError, 2));
      if(curr_to_next_jointError<curr_to_prev_jointError){
        i++;
        return getNearestSetpoint(dt);
      }
    }
    return currentPath[i];

  }
  /** Moves arm to given setpoint. Finishes once within tolerance */
  public MoveArmProfiled(ArmGripper armGripper, String path) {
    createMap();
    m_armGripper = armGripper;
    currentPath = paths.getOrDefault(path, new double[][]{{0.0,0.0,0.0},{0.0,0.0,0.0}});
    addRequirements(armGripper);
    startTime = Timer.getFPGATimestamp();
    this.currProfile = path;
  }

  // Called when the command is initially scheduled.
  @Override
  public void initialize() {
    i=0;
    m_armGripper.setLowerTargetAngle(currentPath[i][0]);
    m_armGripper.setUpperTargetAngle(currentPath[i][1]);
    m_armGripper.setExtensionTargetLength(currentPath[i][2]);
    startTime = Timer.getFPGATimestamp();
  }

  // Called every time the scheduler runs while the command is scheduled.
  @Override
  public void execute() {
    // if (isLowerInTolerance && isUpperInTolerance && isExtensionInTolerance){
    //   i++;
    // }
    // if(currProfile == "ShortThrowMid" || currProfile == "LongThrowHighHD"){
    //   i++;
    // }else{
    //   getNearestSetpoint(Timer.getFPGATimestamp()-prevLoop);
    // }
    i=(int) Math.ceil(Timer.getFPGATimestamp()-startTime)*50; // 50 loops per second = 0.02 seconds per loop
    System.out.println("LOOP");
    System.out.println(i);

    if(i <= currentPath.length-1){
      m_armGripper.setLowerTargetAngle(currentPath[i][0]);
      m_armGripper.setUpperTargetAngle(currentPath[i][1]);
      m_armGripper.setExtensionTargetLength(currentPath[i][2]);
      
      // BeaverLogger.getInstance().logArm(currentPath[i], m_armGripper);
    }else{
      i = currentPath.length-1;
      m_armGripper.setLowerTargetAngle(currentPath[i][0]);
      m_armGripper.setUpperTargetAngle(currentPath[i][1]);
      m_armGripper.setExtensionTargetLength(currentPath[i][2]);
      // BeaverLogger.getInstance().logArm(currentPath[i], m_armGripper);
    }
    

    SmartDashboard.putNumber("lowerSetp", currentPath[i][0]);
    SmartDashboard.putNumber("upperSetp", currentPath[i][1]);
    SmartDashboard.putNumber("extSetp", currentPath[i][2]);
  }

  // Called once the command ends or is interrupted.
  @Override
  public void end(boolean interrupted) {
      System.out.println("PROFILED ARM TO MID FINISHED");
      m_armGripper.setLowerTargetAngle(currentPath[currentPath.length-1][0]);
      m_armGripper.setUpperTargetAngle(currentPath[currentPath.length-1][1]);
      m_armGripper.setExtensionTargetLength(currentPath[currentPath.length-1][2]);
      
      // BeaverLogger.getInstance().logArm(currentPath[currentPath.length-1], m_armGripper);
  }

  // Returns true when the command should end.
  @Override
  public boolean isFinished() {
    //return i>lowerSetpoint.length-1 // try this if it finishes too early
    boolean isLowerInTolerance = Math.abs(m_armGripper.getLowerArmAngleRelative()-currentPath[currentPath.length-1][0])<Tolerances.LOWER_ANGLE;
    boolean isUpperInTolerance = Math.abs(m_armGripper.getUpperArmAngleRelative()-currentPath[currentPath.length-1][1])<Tolerances.UPPER_ANGLE;
    boolean isExtensionInTolerance = Math.abs(m_armGripper.getExtensionDistance()-currentPath[currentPath.length-1][2])<Tolerances.EXTENSION_LENGTH;
    return i>=currentPath.length-1 && (isLowerInTolerance && isUpperInTolerance && isExtensionInTolerance);
  }
}
